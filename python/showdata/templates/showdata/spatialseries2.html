{% extends "base.html" %}
{% load leaflet_tags %}
{% load geojson_tags %}
{% load i18n %}
{% load staticfiles %}
{% block extra_assets %}
    {% leaflet_js %}
    {% leaflet_css %}

    <script src="{% static 'rmap/libs/jquery/2.1.1/jquery.min.js' %}" type="text/javascript"></script>
    <!-- Custom styles for this template -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="{% static 'rmap/libs/jquery-ui-1.12.1/jquery-ui.min.css' %}" type="text/css"/>
    <script type="text/javascript" src="{% static 'rmap/libs/jquery-ui-1.12.1/jquery-ui.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'showdata/PruneCluster.js' %}"></script>

    <!-- TEMPU DOMIUS CALENDAR  -->
    <!-- need jquery!!!!! -->
    <link rel="stylesheet" href="{% static 'showdata/tempusdominus-bootstrap-4.min.css' %}" type="text/css"/>
    <script type="text/javascript" src="{% static 'showdata/moment.js' %}"></script>
    <script type="text/javascript" src="{% static 'showdata/tempusdominus-bootstrap-4.min.js' %}"></script>

    <script>
        // global config for borinud request
        var borinud = {
            config: {
                root_el: null,
                ajax: {
                    baseUrl: "/borinud/api/v1/jsonline",
                    dataType: "text"
                },
            }
        };

        // leaflet color utility
        var colors = ['#3030ff', '#007885', '#00855D', '#0D8500', '#478500', '#788500', '#853C00', '#850000'];

        function getColorIndex(d, min, max) {
            var delta = (max - min) / (colors.length);
            return Math.max(0, Math.min(colors.length - 1, Math.floor((d - min) / delta)));
        }


        function getColor(d, min, max) {
            return colors[getColorIndex(d, min, max)];
        }
    </script>

    <script type="text/javascript" src="{% static 'showdata/borinud.trange.js' %}"></script>
    <script type="text/javascript" src="{% static 'showdata/borinud.level.js' %}"></script>
    <script type="text/javascript" src="{% static 'showdata/borinud.B.js' %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static 'showdata/LeafletStyleSheet.css' %}">

    <style>

        .ui-dialog, .ui-dialog-content {
            background: green;
            z-index: 1000;
        }

        .myDivIcon {
            /*opacity: .9; */
            border: 1px solid #000;
            font-family: "Lucida Grande", "Arial", sans-serif;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            width: 20px;
            height: 14px;
            vertical-align: middle;
            border-radius: 3px;
            -moz-border-radius: 3px;
            -webkit-border-radius: 3px;
            -khtml-border-radius: 3px;
            color: #FFF;
            background: #333;
            line-height: 14px;
        }


        <!--
        .leaflet-label {
            background: rgba(235, 235, 235, 0.95);
            z-index: 10000 !important;
        }

        -->

        select {
            max-width: 250px;
        }

        .select-date {
            max-width: 250px;
            margin-left: 0px;
            margin-right: 0px
        }

        .bootstrap-datetimepicker-widget {
            z-index: 100000;
            min-width: 250px;
        }
    </style>

    <script src="{% static 'showdata/jquery.preload.min.js' %}"></script>

    <script>
        jQuery(function ($) {
            $('#preloadimages img').preload({
                placeholder: '{% static "showdata/loading.gif" %}',
                notFound: '{% static "showdata/access-error-logs.png" %}',
                threshold: 2
            })
        });
    </script>


    <div id="loading" title="{% trans 'Loading data' %}">
        <p>{% trans "Please wait ..." %}</p>
    </div>


    <script>

        $("#loading").dialog({
            hide: 'slide',
            show: 'slide',
            autoOpen: false
        });

        function beforesend() {
            $("#loading").dialog('open').html("<p>{% trans 'Please Wait...' %}</p>");
        }

        // list of identifiers for select, selected_values and corresponding summaries
        var id_select_list = ["ident", "lon_lat", "network", "date", "vars", "timerange", "level"];
        // list of possibible value for each summaries,
        var select_values_lists = {
            ident: [],
            lon_lat: [],
            network: [],
            date: [],
            hour: ["*", "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15",
                "16", "17", "18", "19", "20", "21", "22", "23"],
            vars: [],
            timerange: [],
            level: []
        };

        //contain the option selected in corresponding select, * is a  wildcard
        //at the  start this  are extract from url
        let url_vars = new URL(window.location.href).toString().split("/");
        var selected_values = {
            ident: url_vars[4],
            lon_lat: url_vars[5],
            network: url_vars[6],
            date: url_vars[11] + "-" + url_vars[12] + "-" + url_vars[13],
            hour: url_vars[14] ? url_vars[14] : "*",
            vars: url_vars[9],
            timerange: url_vars[7],
            level: url_vars[8],
        };


        /**
         * required combination of all summaries and put these in select_values_lists
         *
         */
        $.ajax({
            url: borinud.config.ajax.baseUrl + "/*/*/*/*/*/*/summaries",
            dataType: borinud.config.ajax.dataType,
            success: function (resp) {
                console.log(resp)
                resp = (JSON.parse("{\"j\":[" + resp.replace(/}\n{/g, "}, {") + "]}")).j;

                for (var r of resp) {
                    select_values_lists.ident.push(r.ident + "");
                    select_values_lists.lon_lat.push(r.lon + "," + r.lat);
                    select_values_lists.network.push(r.network + "");
                    select_values_lists.date.push((r.date[0] + "").substring(0, 10));
                    let d = r.data[0];
                    select_values_lists.vars.push(Object.keys(d.vars)[0] + "");
                    select_values_lists.timerange.push(d.timerange + "");
                    select_values_lists.level.push(d.level + "");
                }
                populateForm(undefined);
            },
            beforeSend: function () {
                beforesend();
            },
            complete: function () {
                $('#loading').html("<p>Result Complete...</p>");
                $("#loading").dialog('close');
            },
            error: function (e) {
                console.log(e.toString());
            }
        });

        /**
         * Handle the select system of the search form,
         * every time that a select change,
         * set in other select new possible values.
         */
        function populateForm(e) {
            for (let id of id_select_list) {
                if (e && e.id === id) {
                    selected_values[id] = document.getElementById(id).selectedOptions[0].value;
                } else {
                    let index_list = [...Array(select_values_lists[id].length).keys()];
                    for (let id2 of id_select_list) {
                        if (id !== id2) {
                            let target = document.getElementById(id2).selectedOptions[0].value;
                            if (target !== "*") {
                                let temp_index_list = [];
                                for (let i of index_list) {
                                    if (select_values_lists[id2][i] === target) {
                                        temp_index_list.push(i);
                                    }
                                }
                                index_list = temp_index_list;
                            }
                        }
                    }
                    let values = [];
                    for (let i of index_list) {
                        values.push(select_values_lists[id][i]);
                    }
                    populateSelect(id, values);
                }
            }

            // update only calendar filed
            populateDate();
        }

        /**
         * Equal to populateForm but only used for hour, hour not impact on other var
         */
        function populateHour(e) {
            if (e && e.id === "hour") {
                selected_values["hour"] = document.getElementById("hour").selectedOptions[0].value;
            }
        }

        /**
         * populate calendar field and on change use hide filed  data  to get possible value
         */
        function populateDate() {

            let select = document.getElementById("date");
            let options = [];
            for (let i = 0, len = select.options.length; i < len; i++) {
                if (select.options[i].value !== "*") {
                    options.push(select.options[i].value);
                }
            }

            $('#datetimepicker').datetimepicker({
                format: 'L',
                defaultDate: selected_values.date, //selected_values.date,
                enabledDates: options
            });

            $('#datetimepicker').on('change.datetimepicker datetimepicker.change', function (e) {
                // set on hidden field the selected date  and call function that update all filed using onchenge vent
                let selected_date = e.date.toDate();
                selected_date = selected_date.getFullYear() + "-" +
                    ((selected_date.getMonth() + 1 < 10) ? '0' + (selected_date.getMonth() + 1) : '' + (selected_date.getMonth() + 1)) + "-" +
                    ((selected_date.getDate() < 10) ? '0' + (selected_date.getDate()) : '' + (selected_date.getDate()))
                let select = document.getElementById("date");
                let opt = document.createElement('option');
                opt.value = selected_date;
                opt.innerHTML = selected_date;
                opt.selected = true;
                select.appendChild(opt);

                select.dispatchEvent(new Event('change'));
            });

        }


        /**
         *
         * @param id select id
         * @param values options to add to the select
         * Add to the select distinct value and select again the option selected
         * selected_values is a global variable!
         */
        function populateSelect(id, values) {
            //do a distinct operation
            let unique = [...new Set(values)];
            var select = document.getElementById(id);
            //clear select option
            for (i = select.options.length - 1; i >= 0; i--) {
                select.options[i] = null;
            }
            //create  wildcard option
            let opt = document.createElement('option');
            opt.value = "*";
            opt.innerHTML = "*";
            if (selected_values[id] === "*") {
                opt.selected = true;
            }
            select.appendChild(opt);

            //append distinct option to select
            for (var i = 0; i < unique.length; i++) {
                let opt = document.createElement('option');
                opt.value = unique[i];
                let unique_html = unique[i];
                //Use borinud config file to translate code in verbose text
                if (id === "vars") {
                    if (borinud.config.B[unique_html] !== undefined) {
                        unique_html = borinud.config.B[unique_html].description + " " + borinud.config.B[unique_html].unit;
                    }
                } else if (id === "level") {
                    let [l1, l2, l3, l4] = borinud.config.level.decode(unique_html);
                    unique_html = borinud.config.level.describe(l1, l2, l3, l4);
                } else if (id === "timerange") {
                    let [t1, t2, t3, t4] = borinud.config.trange.decode(unique_html);
                    unique_html = borinud.config.trange.describe(t1, t2, t3, t4);
                }
                opt.innerHTML = unique_html;


                if (selected_values[id] === unique[i]) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            }

        }

        /**
         * Copy to clipboard the new url to repeat query with same params
         */
        function copyUrl() {
            //create the new url
            let newUrl = `${url_vars[0]}//${url_vars[2]}/${url_vars[3]}/${selected_values.ident}/${selected_values.lon_lat}/` +
                `${selected_values.network}/${selected_values.timerange}/${selected_values.level}/${selected_values.vars}/` +
                `${url_vars[10]}/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
                `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}`;
            /* Get the text field */
            let copyText = document.getElementById("newUrlClipboard");
            copyText.style.display = 'block';
            copyText.value = newUrl;

            /* Select the text field */
            copyText.select();

            /* Copy the text inside the text field */
            document.execCommand("copy");
            copyText.style.display = 'none';
            alert("New url copy to clipboard.")
        }

    </script>

{% endblock %}

{% block content %}

    <div style="width: 100%">
        <!-- SEARCH BAR -->
        <div class="row">
            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="ident" style="width: 100%">Ident</label>
                <select id="ident" name="ident" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="lon_lat" style="width: 100%">Lon lat</label>
                <select id="lon_lat" name="lon_lat" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="network" style="width: 100%">Network</label>
                <select id="network" name="network" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div hidden>
                <label for="date" style="width: 100%">Date</label>
                <select id="date" name="date" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="container col-sm-6 col-md-4 col-lg-3">
                <div class="row select-date">
                    <div class="col-sm-8">
                        <label for="datetimepicker" style="width: 100%">Date</label>
                        <div class="input-group date" id="datetimepicker" data-target-input="nearest">
                            <div class="row">
                                <input type="text" style="width: 80%"
                                       class="form-control datetimepicker-input col-sm-10"
                                       data-target="#datetimepicker"/>
                                <div class="input-group-append col-sm-2" style="width: 20%"
                                     data-target="#datetimepicker" data-toggle="datetimepicker">
                                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4" style="padding-right: 0;">
                        <label for="hour" style="width: 100%">Hour</label>
                        <select id="hour" name="hour" onchange="populateHour(this)">
                            <option value="*">*</option>
                            <option value="00">00</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="vars" style="width: 100%">Vars</label>
                <select id="vars" name="vars" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="timerange" style="width: 100%">Timerange</label>
                <select id="timerange" name="timerange" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>


            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="level" style="width: 100%">Level</label>
                <select id="level" name="level" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <input id="newUrlClipboard" name="newUrlClipboard" type="text" style="display:none"/>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <br>
                <button class="btn btn-success" style="width: 40%" onclick="copyUrl();">COPY URL</button>
                <button class="btn btn-primary" style="width: 40%" onclick="updateMap();">SEARCH</button>
            </div>

        </div>
    </div>

    <br>
    <br>

    <div id="mapid" style="height: 500px"></div>

    <script>

        //https://github.com/tonekk/Leaflet-Extended-Div-Icon
        (function (L) {
            /*
            * by tonekk. 2014, MIT License
            */

            L.ExtendedDivIcon = L.DivIcon.extend({
                createIcon: function (oldIcon) {
                    let div = L.DivIcon.prototype.createIcon.call(this, oldIcon);

                    if (this.options.id) {
                        div.id = this.options.id;
                    }

                    if (this.options.style) {
                        for (var key in this.options.style) {
                            div.style[key] = this.options.style[key];
                        }
                    }
                    return div;
                }
            });

            L.extendedDivIcon = function (options) {
                return new L.ExtendedDivIcon(options);
            }
        })(window.L);

        // Map init
        var map = L.map('mapid').setView([43, 11], 13);
        var legend = L.control({position: 'bottomright'});
        var coords = [];
        var min = Infinity;
        var max = -Infinity;
        var bcode = {
            "bcode": "B00001",
            "description": "Undefined",
            "unit": "Undefined",
            "offset": 0,
            "scale": 1,
            "userunit": ""
        }


        //update map markers
        function updateMap() {
            //clear map  and  reset values
            map.eachLayer(function (layer) {
                map.removeLayer(layer);
            });
            legend.remove();
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            coords = [];
            min = Infinity;
            max = -Infinity;

            //create request url
            var url = `/borinud/api/v1/geojson/${selected_values.ident}/${selected_values.lon_lat}/` +
                `${selected_values.network}/${selected_values.timerange}/${selected_values.level}/${selected_values.vars}/` +
                `spatialseries/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
                `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=report`;
            //require map point
            $.ajax({
                url: url,
                dataType: "json",
                beforeSend: beforesend,
                success: function (collection) {
                    //require bcode to make legend, value offset and color
                    $.ajax({
                        url: "{% url 'showdata:getbcode' '*'%}".replace("*", selected_values.vars),
                        dataType: "json",
                        beforeSend: beforesend,
                        success: function (response) {
                            bcode = response;
                            for (let i = 0; i < collection['features'].length; i++) {
                                min = Math.min(min, collection['features'][i].properties.val);
                                max = Math.max(max, collection['features'][i].properties.val);
                            }

                            //  Legend
                            legend.onAdd = function (map) {
                                let div = L.DomUtil.create('div', 'info legend');
                                // loop through our density intervals and generate a label with a colored square for each interval
                                let halfdelta = ((max - min) / (colors.length * 2.));

                                for (let i = 0; i < colors.length; i++) {
                                    let grade = min + halfdelta * (i * 2 + 1);
                                    div.innerHTML +=
                                        '<div style="background:white">' +
                                        '<b style="background:' + getColor(grade, min, max) + '">&nbsp;&nbsp;&nbsp;</b>&nbsp;' +
                                        (grade * bcode.scale + bcode.offset).toPrecision(5).replace(/\.?0+$/, "") +
                                        '<br>' +
                                        '</div>';
                                }
                                return div;
                            };

                            legend.addTo(map);

                            ////////////
                            pi2 = Math.PI * 2;
                            L.Icon.MarkerCluster = L.Icon.extend({
                                options: {
                                    iconSize: new L.Point(44, 44),
                                    className: 'prunecluster leaflet-markercluster-icon'
                                },

                                createIcon: function () {
                                    // based on L.Icon.Canvas from shramov/leaflet-plugins (BSD licence)
                                    let e = document.createElement('canvas');
                                    this._setIconStyles(e, 'icon');
                                    let s = this.options.iconSize;
                                    e.width = s.x;
                                    e.height = s.y;
                                    this.draw(e.getContext('2d'), s.x, s.y);
                                    return e;
                                },

                                createShadow: function () {
                                    return null;
                                },

                                draw: function (canvas, width, height) {
                                    let lol = 0;
                                    let start = 0;
                                    let prevalent = 0;
                                    let prevalentindex = 0;
                                    for (let i = 0, l = colors.length; i < l; ++i) {
                                        var size = this.stats[i] / this.population;
                                        if (size > 0) {
                                            if (this.stats[i] > prevalent) {
                                                prevalentindex = i;
                                                prevalent = this.stats[i];
                                            }
                                            canvas.beginPath();
                                            canvas.moveTo(22, 22);
                                            canvas.fillStyle = colors[i];
                                            let from = start;
                                            let to = start + size * pi2;
                                            if (to < from) {
                                                from = start;
                                            }
                                            canvas.arc(22, 22, 22, from, to);
                                            start = to;
                                            canvas.lineTo(22, 22);
                                            //canvas.stroke();
                                            canvas.fill();
                                            canvas.closePath();
                                        }
                                    }
                                    canvas.beginPath();
                                    canvas.fillStyle = colors[prevalentindex];
                                    canvas.arc(22, 22, 15, 0, Math.PI * 2);
                                    canvas.stroke();
                                    canvas.fill();
                                    canvas.closePath();
                                    canvas.fillStyle = '#111';
                                    canvas.textAlign = 'center';
                                    canvas.textBaseline = 'middle';
                                    canvas.font = 'bold 8px sans-serif';
                                    //canvas.fillText(this.population, 22, 22,28);
                                    let halfdelta = ((max - min) / (colors.length * 2.));
                                    let grade = min + halfdelta * (prevalentindex * 2 + 1);
                                    grade = (grade * bcode.scale + bcode.offset).toPrecision(5).replace(/\.?0+$/, "");
                                    canvas.fillText(grade, 22, 22, 28);
                                }
                            });
                            /////////////
                            var pruneCluster = new PruneClusterForLeaflet();
                            pruneCluster.Cluster.Size = 15;
                            //pruneCluster.ProcessView(); // looks like it works OK without this line

                            ////////
                            pruneCluster.BuildLeafletClusterIcon = function (cluster) {
                                let e = new L.Icon.MarkerCluster();
                                e.stats = cluster.stats;
                                e.population = cluster.population;

                                //this try to make the little values more visible (no less of 5%)
                                for (let i = 0, l = e.stats.length; i < l; ++i) {
                                    if ((e.stats[i] > 0) && ((e.stats[i] / e.population) < 0.1)) {
                                        let inc = (e.population * 0.05) - e.stats[i];
                                        e.stats[i] += inc;
                                        e.population += inc;
                                    }
                                }

                                return e;
                            };
                            ////////////

                            pruneCluster.PrepareLeafletMarker = function (leafletMarker, data) {
                                if (leafletMarker.getPopup()) {
                                    //--leafletMarker.setPopupContent(setpopup(data.feature));
                                } else {
                                    //leafletMarker.bindPopup(data.name);
                                    //-leafletMarker.bindPopup(setpopup(data.feature));
                                }
                                let val = (data.feature.properties.val * bcode.scale + bcode.offset).toPrecision(5).replace(/\.?0+$/, "");
                                let vallen = val.length * 6 + 6;
                                leafletMarker.setIcon(
                                    L.extendedDivIcon({
                                        iconSize: new L.Point(vallen, 14),
                                        labelAnchor: [vallen / 2, 0],
                                        html: val,
                                        className: 'myDivIcon',
                                        style: {backgroundColor: getColor(data.feature.properties.val, min, max)}
                                    })
                                );

                                leafletMarker.bindTooltip(data.feature.properties.date.toString());

                                leafletMarker.on('popupopen', function managepreload(e) {
                                    $('#preloadimages img').preload({
                                        placeholder: '{% static "showdata/loading.gif" %}',
                                        notFound: '{% static "showdata/access-error-logs.png" %}'
                                    })
                                });
                            };

                            $.each(collection.features, function (i, feature) {

                                coords.push([feature.geometry.coordinates[1], feature.geometry.coordinates[0]]);

                                let marker = new PruneCluster.Marker(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
                                marker.data.feature = feature;
                                marker.category = getColorIndex(feature.properties.val, min, max);

                                pruneCluster.RegisterMarker(marker);
                            });

                            map.addLayer(pruneCluster);

                            try {
                                map.fitBounds(coords);
                            } catch (err) {
                                $('#loading').html("<p>Error setting bounds...</p>");
                            }

                            $('#loading').html("<p>Result Complete...</p>");
                            $("#loading").dialog('close')
                        }
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $('#loading').html("<p>" + textStatus + "</p><p>Fatal error loading data!</p>");
                }
            })
        }

        updateMap();
    </script>



{% endblock %}
